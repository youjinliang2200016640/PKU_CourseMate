import os, csv, textwrap
from pathlib import Path
import pandas as pd
from openai import OpenAI
import os
from pathlib import Path

os.environ["DEEPSEEK_API_KEY"]="sk-f52246e1729c4dc8a4110f9f0c051068"
MODEL_NAME="deepseek-reasoner"# deepseek-chat / deepseek-reasoner
MAX_TOKENS=8096
TEMPERATURE=0.5
client=OpenAI(api_key=os.getenv("DEEPSEEK_API_KEY"),base_url="https://api.deepseek.com")
DATASET_ROOT=Path("dataset")
if not DATASET_ROOT.exists():
    raise FileNotFoundError("Êú™ÊâæÂà∞ dataset ÁõÆÂΩï")

SYS_PROMPT="‰Ω†ÊòØ‰∏ÄÂêçÂñÑ‰∫éÊèêÁÇºËØæÁ®ãÊµãËØÑË¶ÅÁÇπÁöÑÂåóÂ§ßÂ≠¶ÁîüËØæÁ®ãÂä©Êâã"
USER_PROMPT_TEMPLATE=textwrap.dedent("""
‰ªªÂä°ËØ¥Êòé
    ‰Ω†Â∞ÜÁúãÂà∞Ôºö
    (1)ËØæÁ®ãÂü∫Êú¨‰ø°ÊÅØÔºàCSV ËΩ¨‰∏∫ Markdown Ë°®Ê†ºÂΩ¢ÂºèÔºâ
    (2)Ëã•Âπ≤Êù°Â≠¶ÁîüÊµãËØÑÔºàÂèØËÉΩ‰∏∫Á©∫Ôºâ\
Â≠¶ÁîüÊµãËØÑÁöÑÊ†ºÂºèÊòØ
1.xxx
...
2.xxx
...
Ë°®Á§∫‰∏çÂêåÂêåÂ≠¶ÂèëË°®ÁöÑÊµãËØÑ„ÄÇÂú®Âêå‰∏Ä‰∏™ÊñáÊú¨‰∏≠ÁöÑ‰∏ÄÂÆöÊòØÂêå‰∏ÄÈó®ËØæÁ®ãÔºà‰∏ç‰øùËØÅÊòØÂêå‰∏Ä‰∏™‰ªªËØæËÄÅÂ∏àÔºâ„ÄÇ
                                     
ËØ∑‰Ω†ÊåâÁÖßÔºöËØæÁ®ãÈöæÂ∫¶‰∏é‰ªªÂä°Èáè„ÄÅËØæÁ®ãÂê¨ÊÑü‰∏éÊî∂Ëé∑„ÄÅÁªôÂàÜÂ•ΩÂùè„ÄÅÊÄªÁªìËøôÂõõ‰∏™Ê®°ÂùóÁªôÂá∫ËØ•Èó®ËØæÁ®ãÁöÑÊÄªÁªì„ÄÇ‰∏ãÈù¢ÂØπÂêÑÈÉ®ÂàÜ‰Ω†Ë¶ÅËæìÂá∫ÁöÑÂÜÖÂÆπËøõË°åÂÖ∑‰ΩìËß£Èáä„ÄÇÊ≥®ÊÑèÔºå‰Ω†‰∏ç‰∏ÄÂÆöÈúÄË¶Å‰∏•Ê†ºÊåâÁÖßËß£ÈáäÊù•ÔºàÂõ†‰∏∫ÂèØËÉΩÊúâ‰ø°ÊÅØÁº∫Â§±ÔºâÂÆåÊàêÊØèÈÉ®ÂàÜÔºåÁîöËá≥‰Ω†‰∏ç‰∏ÄÂÆöÈúÄË¶ÅÊää‰∫î‰∏™ÈÉ®ÂàÜÈÉΩÂÜôÔºåÂõ†‰∏∫ÂèØËÉΩÊúâ‰ø°ÊÅØÁº∫Â§±„ÄÇÊúâÂ§öÂ∞ë‰ø°ÊÅØÔºåÂ∞±ËØ∑Â∞ΩÂèØËÉΩÂÆåÊàêÂ§öÂ∞ëÈÉ®ÂàÜ„ÄÇÂè¶Â§ñÔºåÁî±‰∫é‰∏çÂêåÂ≠¶ÁîüÊúâ‰∏çÂêåÁöÑËÉΩÂäõ„ÄÅÁõÆÁöÑÔºåÂõ†Ê≠§Âêå‰∏ÄÈó®ËØæÁ®ãÂèØËÉΩ‰ºöÁªôÂá∫Êà™ÁÑ∂Áõ∏ÂèçÁöÑËØÑ‰ª∑ÔºåÂõ†Ê≠§‰Ω†ÈúÄË¶ÅÁªºÂêàËÄÉËôëËøô‰∫õËØÑ‰ª∑ÔºåÁªôÂá∫ÂÖ®Èù¢ËÄåÂÆ¢ËßÇÁöÑÊÄªÁªì„ÄÇ\
Ôºà1ÔºâËØæÁ®ãÈöæÂ∫¶‰∏é‰ªªÂä°ÈáèÔºö‰∏ÄÈó®ËØæÁ®ãÈúÄË¶ÅÁöÑÂÖà‰øÆÁü•ËØÜÔºåÂÆπ‰∏çÂÆπÊòìÂê¨ÊáÇÔºåÊØèÂë®Â§ßÊ¶ÇÈúÄË¶ÅËä±Â§öÂ∞ëÊó∂Èó¥ÂÜô‰Ωú‰∏ö/ËÆ∫Êñá/labÔºåËÄÉËØïÈöæÂ∫¶Â¶Ç‰ΩïÁ≠â„ÄÇ\
Ôºà2ÔºâËØæÁ®ãÂê¨ÊÑü‰∏éÊî∂Ëé∑ÔºöËÄÅÂ∏àÊéàËØæËäÇÂ•è‰∏éÂÜÖÂÆπË¥®ÈáèÂàÜÂà´Â¶Ç‰ΩïÔºåÂà∞Âú∫Âê¨ËØæÊòØÂê¶ÊúâÊòéÊòæÂ∏ÆÂä©ÔºåPPT/Êùø‰π¶/ËÆ≤‰πâË¥®ÈáèÂ¶Ç‰ΩïÁ≠â„ÄÇ\
Ôºà3ÔºâÁªôÂàÜÂ•ΩÂùèÔºöÁªôÂàÜÂ¶Ç‰ΩïÔºàÊòØÂê¶ÂÆπÊòìÊãøÈ´òÂàÜÔºâÔºåÊÄªËØÑÊàêÁª©ÊûÑÊàêÔºåÊúâÊó†Á≠æÂà∞ÔºåÊòØÂê¶Ë∞ÉÂàÜÁ≠â„ÄÇ\
Ôºà4ÔºâÊÄªÁªìÔºöËØ•ËØæÁ®ãÈÄÇÂêà‰ªÄ‰πàÊ†∑ÁöÑÂ≠¶ÁîüÈÄâÊã©ÔºåÊòØÂê¶Êé®ËçêÈùûÂøÖ‰øÆÁöÑÂ≠¶ÁîüÈÄâËØæÔºåÂ¶ÇÊûúÈÄâËØæ‰∫ÜÊúÄÂ•ΩÊåâÁÖß‰ªÄ‰πàÊ†∑ÁöÑÊñπÊ≥ïÂ≠¶‰π†Ôºå‰ª•ÂèäÂØπÔºà1Ôºâ-Ôºà3ÔºâÈÉ®ÂàÜÁöÑÊ¶ÇÊã¨ÔºåÂØπËØæÁ®ãÊÄª‰ΩìÁöÑÊÄªÁªì„ÄÇ\

ËØ∑Ê≥®ÊÑèÔºöÂØπ‰∫éËã±ËØ≠ËØæ„ÄÅ‰ΩìËÇ≤ËØæÔºåÁî±‰∫éËøôÁ±ªËØæÁ®ã‰∏ç‰∏ÄÂÆöÊòØÁªüËÄÉÔºåËÄÅÂ∏àÂØπËØæÁ®ãÊúâÂæàÂ§ßÁöÑÂΩ±ÂìçÔºå‰∏îÂú®ÈÄâÊã©ÁöÑÊó∂ÂÄôÊúâËæÉÂº∫ÁöÑÈÄâÊã©ÊÄßÔºåËØ∑‰Ω†Âú®ËæìÂá∫‰ª•‰∏äÂÜÖÂÆπÊó∂ÔºåÊåâ‰∏çÂêåÁöÑÊéàËØæÊïôÂ∏àËøõË°åËÆ®ËÆ∫„ÄÇÂØπ‰∫é‰∏ì‰∏öËØæ„ÄÅÈÄöËØÜËØæ„ÄÅÂÖ¨ÈÄâËØæÔºåÁî±‰∫é‰∏ÄËà¨Âè™Êúâ‰∏Ä‰∏™Áè≠Á∫ßÊ≤°ÂæóÈÄâÔºåÂõ†Ê≠§‰∏çÈúÄË¶ÅÂàÜÁ±ªËÆ®ËÆ∫„ÄÇ

ÊµãËØÑÊñáÁ´†‰∏≠ÂèØËÉΩÊúâ‰∏Ä‰∫õÂêçËØçÔºåÊòØÂåóÂ§ßÂ≠¶ÁîüÁâπÊúâÁöÑ‚ÄúÁΩëÁªúÈªëËØù‚ÄùÔºå‰∏ãÈù¢Êàë‰ºöÂ∞ΩÂèØËÉΩËØ¶ÁªÜÁöÑÁªô‰Ω†Ëß£ÈáäÔºàÊ≥®ÊÑèËøô‰∫õËß£Èáä‰ªÖ‰æõ‰Ω†ÁêÜËß£ÊµãËØÑÊñáÊú¨‰∏≠ÂèØËÉΩ‰∏çÂ•ΩÁêÜËß£ÁöÑÂêçËØçÔºå‰ΩÜÊòØËØ∑‰∏çË¶ÅÂéüÂ∞Å‰∏çÂä®ÂëàÁé∞Ëøô‰∫õËß£ÈáäÔºâÔºö
a.Ê≠£ÊÄÅÔºöÂåó‰∫¨Â§ßÂ≠¶ËßÑÂÆöÔºåÈô§ÈùûËÄÅÂ∏àÁî≥ËØ∑Ë∂Ö‰ºòÁßÄÁéáÔºåÂê¶Âàô‰∏ÄÈó®ËØæ85ÂàÜ‰ª•‰∏äÁöÑÂ≠¶Áîü‰∏çÂæóË∂ÖËøá40%„ÄÇÂõ†Ê≠§ÔºåÊúâ‰∫õËÄÅÂ∏à‰∏∫‰∫ÜÊª°Ë∂≥‰ºòÁßÄÁéáËßÑÂÆöÔºå‰ºöÊääÊú¨Êù•È´ò‰∫é85ÂàÜÁöÑÂ≠¶ÁîüÁªôÂº∫Ë°åÈôçÂà∞84ÂàÜÊàñËÄÖ84.5ÂàÜÔºåÊ≠§Âç≥‰∏∫‚ÄúÊ≠£ÊÄÅÂàÜÂ∏É‚ÄùÔºåÂêéÂ≠¶ÁîüÂ∏∏Áß∞‰∏∫‚ÄúÊ≠£ÊÄÅ‚ÄùÊàñËÄÖ‚ÄúÊ≠£Â§™‚Äù„ÄÇ‰∏çËøáÔºåÂ¶ÇÊûú‰∏ÄÂêçÂ≠¶ÁîüÊÅ∞Â•ΩÊãø‰∫Ü84ÂàÜÔºå‰πüÊúâÂèØËÉΩËØ¥Ëá™Â∑±ÁöÑÊàêÁª©ÊòØ‚ÄúÊ≠£ÊÄÅ‚ÄùÔºåËøôÊòØËØ≠‰πâÁöÑÊé®Âπø„ÄÇ
b.PFÔºöPass/FailÂà∂ÔºåÊòØ‰∏ÄÁßçÁâπÊÆäÁöÑÊàêÁª©ËÆ∞ËΩΩÊñπÂºèÔºåÂè™ËÆ∞ÂΩïÂêàÊ†º/‰∏çÂêàÊ†ºÔºå‰∏î‰∏çÂèÇ‰∏éGPAËÆ°ÁÆó„ÄÇÂú®2020-2022Âπ¥ÁöÑÈÉ®ÂàÜËØæÁ®ãÔºåÁî±‰∫é‰∏≠ÂõΩÂ§ßÈôÜÁöÑÁñ´ÊÉÖÊîøÁ≠ñÈôêÂà∂ÔºåÈÉ®ÂàÜËØæÁ®ãË¢´Ëø´Á∫ø‰∏ä„ÄÇÊúâ‰∫õËØæÁ®ãÊé®Âá∫‰∫ÜËá™ÈÄâPFÂà∂/Âº∫Âà∂PFÂà∂„ÄÇÂú®Â¶Ç‰ªäÁÆ°Âà∂ÁªìÊùüÂêéÔºå‰ªçÊúâÈÉ®ÂàÜËØæÁ®ã‰øùÁïô‰∫ÜËøô‰∏ÄÂà∂Â∫¶Ôºå‰ΩÜÂ§ßÂ§öÊòØ‰∏ÄÂºÄÂßãÂ∞±ËØ¥Ê∏ÖÊ•öPFÂà∂ËøòÊòØÁôæÂàÜÂà∂ÔºåËÄå‰∏çÂèØ‰ª•Ëá™ÈÄâ„ÄÇPFÂà∂ÁöÑËØæÁ®ãÁî±‰∫é‰∏çÂèÇ‰∏éGPAËÆ°ÁÆóÔºåÂõ†Ê≠§ÂæàÂ§öÂ≠¶ÁîüÊäïÂÖ•Á≤æÂäõËæÉÂ∞ë„ÄÇ
c.ÂΩ©Ëôπ/üåàÔºöÊåáËØæÁ®ãÊÄªËØÑÊãøÂà∞‰∫Ü100ÂàÜ„ÄÇ
d.‰∏§/‰∏â‰∏™Áúã‰ººÊó†ÊÑè‰πâÁöÑËã±ÊñáÂ≠óÊØçÔºö‰∏ÄËà¨ÊòØÊéàËØæËÄÅÂ∏à‰∏≠ÊñáÂêçÁöÑÊãºÈü≥È¶ñÂ≠óÊØç„ÄÇ‰æãÂ¶ÇÔºå‚ÄúÈôàÂêëÁæ§‚ÄùÁÆÄÂÜô‰∏∫cxqÔºå‚ÄúÂÜØÁ°ï‚ÄùÁÆÄÂÜô‰∏∫fs„ÄÇ
e.AÁ∫ß/BÁ∫ß/CÁ∫ß/C+Á∫ßÔºöÂåó‰∫¨Â§ßÂ≠¶Ëã±ËØ≠ÂàÜÁ∫ß‰ΩìÂà∂„ÄÇÂÖ•Â≠¶Êó∂ÂêåÂ≠¶‰ª¨‰ºöÂèÇÂä†‰∏ÄÂú∫Ëã±ËØ≠ÂàÜÁ∫ßËÄÉËØïÔºåÊ†πÊçÆÁªìÊûúÈÄâÊã©‰∏çÂêåÂ≠¶ÂàÜÂíåÈöæÂ∫¶ÁöÑËã±ËØ≠ËØæ„ÄÇ‰ªéAÂà∞C+ÈúÄË¶ÅÁöÑÂ≠¶ÂàÜÊï∞ÂáèÂ∞ëÔºåÈöæÂ∫¶Â¢ûÂä†„ÄÇ
f.Âú∞ÈúáÊ¶ÇËÆ∫ÔºöÊúâ‰∏§‰∏™Âê´‰πâ„ÄÇÁ¨¨‰∏Ä‰∏™Âê´‰πâÊòØÔºåÂú∞ÈúáÊ¶ÇËÆ∫Êú¨Ë∫´ÊòØÂú∞ÁêÉ‰∏éÁ©∫Èó¥ÁßëÂ≠¶Â≠¶Èô¢ÂºÄËÆæÁöÑ‰∏ÄÈó®ÈÄöËØÜËØæÔºåÂõ†ÂÖ∂‰∏çÁ≠æÂà∞„ÄÅÂÆπÊòìÂæóÊª°ÂàÜÈ´òÂàÜ„ÄÅ‰ªªÂä°ÈáèÂ∞èËÄåËëóÂêçÔºåË¢´‰∫∫Áß∞‰∏∫‚ÄúÂåóÂ§ßÁ¨¨‰∏ÄÊ∞¥ËØæ‚Äù„ÄÇÂè¶‰∏ÄÁßçÂê´‰πâÊòØ‰∏ÄÁßçÂΩ¢ÂÆπËØçÔºåÂõ†‰∏∫Êú¨ËØæÁ®ãÂÆûÂú®Â§™ËëóÂêçÔºåÊâÄ‰ª•Êúâ‰∫∫Êãø‚ÄúÂú∞ÈúáÊ¶ÇËÆ∫‚ÄùÊù•ÂΩ¢ÂÆπ‰∏ÄÈó®ËØæÔºåÂèØËÉΩÂú®Ë°®Á§∫Ëøô‰πàËØæ‰∫ãÂ∞ëËØæÊ∞¥ÁªôÂàÜÂ•Ω„ÄÇ
g.‰∏Ä‰∫õÂ≠¶Èô¢ÁöÑÁÆÄÁß∞Ôºöxk=‰ø°Áßë=‰ø°ÊÅØÁßëÂ≠¶ÊäÄÊúØÂ≠¶Èô¢Ôºåsms=school of mathematical science=Êï∞Èô¢=Êï∞Â≠¶ÁßëÂ≠¶Â≠¶Èô¢Ôºågy=Â∑•Â≠¶Èô¢Ôºåwy=Áâ©ÁêÜÂ≠¶Èô¢ Êàñ Â§ñÂõΩËØ≠Â≠¶Èô¢ÔºàÂèØËÉΩÊúâÊ≠ß‰πâÔºåÈúÄË¶Å‰Ω†Ê†πÊçÆcontextÁêÜËß£ÔºåÂõ†‰∏∫‰∏§‰∏™Â≠¶Èô¢ÊãºÈü≥È¶ñÂ≠óÊØçÈÉΩÊòØwyÔºâÔºåccme=ÂåñÂ≠¶‰∏éÂàÜÂ≠êÂ∑•Á®ãÂ≠¶Èô¢Ôºåsky=ÁîüÂëΩÁßëÂ≠¶Â≠¶Èô¢Ôºågsm=ÂÖâÂçéÁÆ°ÁêÜÂ≠¶Èô¢Ôºåjy=ÁªèÊµéÂ≠¶Èô¢Ôºånsd=ÂõΩÂÆ∂ÂèëÂ±ïÁ†îÁ©∂Èô¢„ÄÇ
h.dzÔºöÊåá‚ÄúÊ¥û‰∏ª‚ÄùÔºåÁõ∏ÂΩì‰∫éÁôæÂ∫¶Ë¥¥Âêß‰∏≠ÁöÑË¥¥‰∏ªÔºåÊåáÂèëÂ∏ñ‰∫∫Ëá™Â∑±„ÄÇ
i.ËÇ•Áå¥/ËµõËâáÔºöÊåáÂåóÂ§ßÂ≠¶ÁîüÂ∏∏Áî®‰∫éËé∑ÂèñÂæÄÂπ¥È¢ò‰∏éËØæÁ®ãËµÑÊñôÁöÑ‰∏§‰∏™Âπ≥Âè∞„ÄÇ\
                                     
ËæìÂá∫Ë¶ÅÊ±ÇÔºöËØ∑‰ΩøÁî® Markdown ËæìÂá∫‰∏ÄÊÆµ300-800Â≠óÁöÑ‰∏≠ÊñáÊÄªÁªìÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
### ËØæÁ®ãÂêçÁß∞ÔºàÁÑ∂ÂêéÂú®Ëøô‰∏™Êã¨Âè∑ÂÜÖÂÜô‰∏äÂºÄËØæÈô¢Á≥ª‰∏éÂ≠¶ÂàÜÊï∞Ôºâ

#### ËØæÁ®ãÈöæÂ∫¶‰∏é‰ªªÂä°Èáè  
...

#### ËØæÁ®ãÂê¨ÊÑü‰∏éÊî∂Ëé∑  
...

#### ÁªôÂàÜÂ•ΩÂùè  
...

#### ÊÄªÁªì‰∏éÂª∫ËÆÆ  
...

Ëã•ÊµãËØÑ‰∏∫Á©∫ÔºåËØ∑Ê†πÊçÆËØæÁ®ãÂü∫Êú¨‰ø°ÊÅØÂêàÁêÜÊé®ÊµãÔºåÁªìÂ∞æÂä†‰∏äÔºö‚ÄúÊèêÁ§∫Ôºö‰ª•‰∏äÂÜÖÂÆπÂü∫‰∫éËØæÁ®ãÂü∫Êú¨‰ø°ÊÅØÁî±LLMÊé®ÊµãÂæóÂà∞ÔºåÂπ∂ÈùûÊù•Ëá™Â≠¶ÁîüÊµãËØÑÔºåËØ∑Ë∞®ÊÖéÂèÇËÄÉÔºÅ‚Äù
Ëã•‰∏∫Ëã±ËØ≠ËØæ/‰ΩìËÇ≤ËØæÔºåËØ∑Êåâ‰∏çÂêåÊéàËØæÊïôÂ∏àÂàÜÂà´ËÆ®ËÆ∫ÔºõÂÖ∂‰ªñËØæÁ®ãÊó†ÈúÄ„ÄÇ
Á¶ÅÊ≠¢ÈÄêÂè•Â§çÂà∂ÂéüÊñáÔºåÂèØÂΩíÁ∫≥ÂºïÁî®„ÄÇËã•‰ø°ÊÅØ‰∏•Èáç‰∏çË∂≥ÂèØÈÄÇÂΩìÁúÅÁï•ÈÉ®ÂàÜÊ®°Âùó„ÄÇ
                                     
###ËØæÁ®ãÂü∫Êú¨‰ø°ÊÅØ
    {INFO_MD}
###Â≠¶ÁîüÊµãËØÑ
    {EVAL_TEXT}""")

def csv_to_md_table(csv_path: Path)->str:
    df = pd.read_csv(csv_path)
    return df.to_markdown(index=False)
def read_txt(path: Path) -> str:
    return path.read_text("utf-8", errors="ignore").strip() if path.exists() else ""
def call_llm(info_md: str, eval_text: str)->str:
    prompt=USER_PROMPT_TEMPLATE.format(INFO_MD=info_md, EVAL_TEXT=eval_text or"ÔºàÊó†Ôºâ")
    resp=client.chat.completions.create(
        model=MODEL_NAME,
        max_tokens =MAX_TOKENS,
        temperature=TEMPERATURE,
        messages=[
            {"role": "system","content": SYS_PROMPT},
            {"role": "user","content": prompt}
        ],
        stream=False
    )
    return resp.choices[0].message.content.strip()
def process_course(course_dir:Path):
    info_csv=course_dir/"info.csv"
    pzxy_txt=course_dir/"evaluation_pzxy.txt"
    th_txt=course_dir/"evaluation_treehole.txt"
    out_md=course_dir/"AI_summary.md"
    if out_md.exists():
        content = out_md.read_text(encoding="utf-8").strip()
        if content:
            print(f"Â∑≤ÊúâÊÄªÁªìÔºåË∑≥Ëøá {out_md.relative_to(DATASET_ROOT.parent)}")
            return
    info_md =csv_to_md_table(info_csv) if info_csv.exists() else "ÔºàÁº∫Â∞ëinfo.csvÔºâ"
    eval_txt="\n\n".join([read_txt(pzxy_txt), read_txt(th_txt)]).strip()
    try:
        summary=call_llm(info_md,eval_txt)
        out_md.write_text(summary,encoding="utf-8")
        print(f"ÁîüÊàê {out_md.relative_to(DATASET_ROOT.parent)}")
    except Exception as e:
        print(f"Â§±Ë¥• {course_dir.name}‚Äî{e}")
for cat_dir in DATASET_ROOT.iterdir():
    if not cat_dir.is_dir(): continue
    for school_dir in cat_dir.iterdir():
        if not school_dir.is_dir(): continue
        for course_dir in school_dir.iterdir():
            if course_dir.is_dir():
                process_course(course_dir)
